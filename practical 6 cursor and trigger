create table info(rollno number(20), name varchar2(20), branch varchar2(20));
create table info1(rollno number(20), name varchar2(20), branch varchar2(20));

insert into info values(1, 'Om' , 'Computer');
insert into info values (2, 'Raj' , 'Mech');
insert into info values (3, 'Sai' , 'ECE');
insert into info1 values (5, 'Rahul' , 'IT');
insert into info1 values (2, 'Raj' , 'Mech');
insert into info1 values (6, 'Pravin' , 'Comp');

DECLARE
    rn info.rollno%TYPE;
    nm info.name%TYPE;
    br info.branch%TYPE;

    -- Parameterized cursor: gets missing rows for a specific branch
    CURSOR c_info(p_branch VARCHAR2) IS
        SELECT rollno, name, branch 
        FROM info
        WHERE branch = p_branch
        MINUS
        SELECT rollno, name, branch 
        FROM info1
        WHERE branch = p_branch;

    -- Cursor to get all unique branch names
    CURSOR c_branch IS
        SELECT DISTINCT branch FROM info;

BEGIN
    -- Loop through each branch automatically
    FOR b IN c_branch LOOP
        DBMS_OUTPUT.PUT_LINE('Processing branch: ' || b.branch);
        
        FOR rec IN c_info(b.branch) LOOP
            INSERT INTO info1 VALUES (rec.rollno, rec.name, rec.branch);
            DBMS_OUTPUT.PUT_LINE('Inserted Roll No: ' || rec.rollno || ' Name: ' || rec.name);
        END LOOP;
    END LOOP;

    DBMS_OUTPUT.PUT_LINE('âœ… All missing records inserted successfully!');
END;
/


-----------------------------------------------------TRIGGER----------------------------------------------------------------------------------
-- Step 1: Create the main table LIB1
CREATE TABLE LIB1 (
    RollNo NUMBER(5),
    Name VARCHAR2(50),
    BookName VARCHAR2(100)
);

-- Step 2: Insert some sample data into LIB1
INSERT INTO LIB1 VALUES (101, 'Sakshi Tarde', 'Database Management System');
INSERT INTO LIB1 VALUES (102, 'Rohan Patil', 'Operating System Concepts');
INSERT INTO LIB1 VALUES (103, 'Priya Deshmukh', 'Computer Networks');
INSERT INTO LIB1 VALUES (104, 'Amit Shinde', 'Data Structures');
INSERT INTO LIB1 VALUES (105, 'Neha Jadhav', 'OOP with C++');

COMMIT;

-- Step 3: Create the audit table LIB_AUDIT
CREATE TABLE LIB_AUDIT (
    RollNo NUMBER(5),
    Name VARCHAR2(50),
    BookName VARCHAR2(100)
);

-- Step 4: Create the trigger to capture old records on UPDATE or DELETE
CREATE OR REPLACE TRIGGER test
AFTER DELETE OR UPDATE ON LIB1
REFERENCING OLD AS o NEW AS n
FOR EACH ROW
BEGIN
    INSERT INTO LIB_AUDIT VALUES (:o.RollNo, :o.Name, :o.BookName);
END;
/
-- The forward slash ( / ) executes the PL/SQL block in SQL*Plus

-- Step 5: Check for errors in the trigger
SHOW ERRORS TRIGGER test;

-- Step 6: Test the trigger
-- Update a record in LIB1
UPDATE LIB1 SET BookName = 'Advanced Database Systems' WHERE RollNo = 101;

-- Delete a record from LIB1
DELETE FROM LIB1 WHERE RollNo = 102;

COMMIT;

-- Step 7: View the audit records
SELECT * FROM LIB_AUDIT;

-- Step 8: View the current records in LIB1
SELECT * FROM LIB1;
